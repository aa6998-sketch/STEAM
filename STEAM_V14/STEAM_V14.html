<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>七堵國小 STEAM MAKER 創客教室</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Noto Sans TC 字型 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&family=Patrick+Hand&display=swap" rel="stylesheet">
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 引入 Canvas Confetti (慶祝特效) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            /* 預設主題變數 (活力七堵) */
            --color-primary: #2563eb; /* blue-600 */
            --color-secondary: #4ade80; /* green-400 */
            --color-accent: #facc15; /* yellow-400 */
            --bg-gradient-from: #FF6B6B;
            --bg-gradient-to: #4ECDC4;
            --text-color-heading: #111827;
        }

        /* 耶誕主題 */
        [data-theme="christmas"] {
            --color-primary: #dc2626; /* red-600 */
            --color-secondary: #16a34a; /* green-600 */
            --color-accent: #fbbf24; /* amber-400 */
            --bg-gradient-from: #14532d; /* green-900 */
            --bg-gradient-to: #b91c1c; /* red-700 */
        }

        /* 海洋主題 */
        [data-theme="ocean"] {
            --color-primary: #0284c7; /* sky-600 */
            --color-secondary: #22d3ee; /* cyan-400 */
            --color-accent: #7dd3fc; /* sky-300 */
            --bg-gradient-from: #0f172a; /* slate-900 */
            --bg-gradient-to: #0ea5e9; /* sky-500 */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
            scroll-behavior: smooth;
            overflow-x: hidden;
        }
        
        .font-handwriting {
            font-family: 'Patrick Hand', cursive, 'Noto Sans TC', sans-serif;
        }

        /* 動態背景漸層 */
        .steam-gradient {
            background: linear-gradient(135deg, var(--bg-gradient-from) 0%, var(--bg-gradient-to) 100%);
            transition: background 0.5s ease;
        }

        /* 應用主題色的元素 */
        .theme-text-primary { color: var(--color-primary); transition: color 0.3s; }
        .theme-bg-secondary { background-color: var(--color-secondary); transition: background-color 0.3s; }
        .theme-border-accent { border-color: var(--color-accent); transition: border-color 0.3s; }
        .theme-decoration-line { background-color: var(--color-secondary); transition: background-color 0.3s; }

        /* 視差背景 */
        .parallax-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .parallax-item {
            position: absolute;
            opacity: 0.15;
            transition: transform 0.1s linear, color 0.3s;
        }

        .grid-bg {
            background-color: #2a2a2a;
            background-image: radial-gradient(#1a1a1a 20%, transparent 20%);
            background-size: 40px 40px;
            background-position: 0 0;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }
        canvas {
            cursor: crosshair;
            touch-action: none; 
        }
        .nav-link {
            position: relative;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 0;
            background-color: var(--color-secondary);
            transition: width 0.3s, background-color 0.3s;
        }
        .nav-link:hover::after {
            width: 100%;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
            animation: blob 7s infinite;
        }
        .tape-effect {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%) rotate(-2deg);
            width: 100px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 10;
            backdrop-filter: blur(2px);
        }

        /* 吉祥物動畫 */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes jump {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
        }
        .mascot-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 50;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .mascot-container:hover {
            transform: scale(1.1);
        }
        .mascot-idle {
            animation: jump 1s ease-in-out infinite;
        }
        
        .speech-bubble {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-20%) scale(0);
            background: white;
            padding: 12px 18px;
            border-radius: 20px;
            border-bottom-left-radius: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            width: 220px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: #333;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            border: 2px solid var(--color-primary);
            font-weight: bold;
            z-index: 51;
        }
        .mascot-container.speaking .speech-bubble {
            opacity: 1;
            transform: translateX(-20%) scale(1);
        }
    </style>
</head>
<body class="text-gray-800" data-theme="default">

    <!-- 視差背景層 -->
    <div class="parallax-bg" id="parallaxLayer">
        <!-- 這些元素的顏色會隨主題微調 -->
        <i data-lucide="settings" class="parallax-item text-gray-400 w-32 h-32" style="top: 10%; left: 5%;" data-speed="0.2"></i>
        <i data-lucide="hexagon" class="parallax-item theme-text-primary opacity-20 w-24 h-24" style="top: 30%; right: 10%;" data-speed="-0.3"></i>
        <i data-lucide="triangle" class="parallax-item text-yellow-300 w-16 h-16" style="top: 60%; left: 15%;" data-speed="0.5"></i>
        <i data-lucide="circle" class="parallax-item theme-text-primary opacity-10 w-40 h-40" style="top: 80%; right: 20%;" data-speed="-0.1"></i>
        <i data-lucide="settings-2" class="parallax-item text-gray-300 w-20 h-20" style="top: 15%; left: 40%;" data-speed="0.1"></i>
    </div>

    <!-- 七堵小超人吉祥物 (滑鼠接觸說話) -->
    <div class="mascot-container" id="mascot" onmouseenter="mascotInteract()">
        <div class="speech-bubble" id="mascotSpeech">嗨！我是七堵小超人！<br>滑鼠碰我聽聽知識！</div>
        <img src="校徽cute版.png" alt="七堵小超人" class="w-24 h-24 drop-shadow-2xl">
        <div class="w-16 h-4 bg-black/20 rounded-[100%] mx-auto mt-[-5px] blur-sm opacity-50"></div>
    </div>

    <!-- 背景音樂控制 -->
    <div class="fixed bottom-4 right-4 z-50 bg-white p-2 rounded-full shadow-lg flex items-center gap-2 border border-gray-200">
        <audio id="bgMusic" loop autoplay>
            <source src="My ProjectD.m4a" type="audio/mp4">
        </audio>
        <button onclick="toggleMusic()" class="p-2 rounded-full hover:bg-gray-100 text-pink-500 transition">
            <i id="musicIcon" data-lucide="music" class="w-6 h-6"></i>
        </button>
        <span class="text-xs font-bold text-gray-500 pr-2">背景音樂</span>
    </div>

    <!-- 導航列 -->
    <nav class="bg-white/95 backdrop-blur shadow-md fixed w-full z-50 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-28">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-4">
                        <img src="校徽cute版.png" alt="七堵國小校徽" class="w-24 h-24 object-contain hover:scale-110 transition duration-300">
                        <div>
                            <h1 class="text-2xl font-black tracking-wider text-gray-900">七堵國小</h1>
                            <span class="text-xs font-bold tracking-[0.2em] theme-text-primary">STEAM MAKER</span>
                        </div>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="#home" class="nav-link font-bold text-gray-600 hover:text-gray-900">首頁</a>
                    <a href="#philosophy" class="nav-link font-bold text-gray-600 hover:text-gray-900">教學理念</a>
                    <a href="#maker-gallery" class="nav-link font-bold text-gray-600 hover:text-gray-900">MAKER花絮</a>
                    <a href="#simulator" class="nav-link font-bold text-gray-600 hover:text-gray-900">線上積木牆</a>
                    <a href="#gallery" class="nav-link font-bold text-gray-600 hover:text-gray-900">作品引導</a>
                    
                    <!-- 主題切換器 -->
                    <div class="relative ml-4" id="themeDropdown">
                        <button onclick="toggleThemeMenu(event)" class="flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full text-sm font-bold text-gray-600 hover:bg-gray-200 transition focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-300">
                            <i data-lucide="palette" class="w-4 h-4"></i> 色彩主題
                            <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </button>
                        <div id="themeMenu" class="absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-xl border border-gray-100 overflow-hidden hidden transform origin-top-right transition-all duration-200 z-50">
                            <button onclick="setTheme('default')" class="w-full text-left px-4 py-3 text-sm hover:bg-blue-50 text-blue-600 font-bold flex items-center border-b border-gray-50">
                                <span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span> 活力七堵
                            </button>
                            <button onclick="setTheme('christmas')" class="w-full text-left px-4 py-3 text-sm hover:bg-red-50 text-red-600 font-bold flex items-center border-b border-gray-50">
                                <span class="w-3 h-3 rounded-full bg-red-600 mr-2"></span> 耶誕慶典
                            </button>
                            <button onclick="setTheme('ocean')" class="w-full text-left px-4 py-3 text-sm hover:bg-cyan-50 text-cyan-600 font-bold flex items-center">
                                <span class="w-3 h-3 rounded-full bg-cyan-500 mr-2"></span> 海洋之都
                            </button>
                        </div>
                    </div>
                </div>
                <div class="md:hidden flex items-center">
                    <button class="text-gray-600 hover:text-gray-900">
                        <i data-lucide="menu" class="w-8 h-8"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero 區塊 -->
    <section id="home" class="pt-36 pb-12 md:pt-48 md:pb-24 steam-gradient text-white relative overflow-hidden z-10">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full translate-x-1/2 -translate-y-1/2"></div>
        <div class="absolute bottom-0 left-0 w-96 h-96 bg-blue-900 opacity-10 rounded-full -translate-x-1/2 translate-y-1/2"></div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
            <div class="flex flex-col md:flex-row items-center justify-between gap-12">
                <div class="md:w-1/2 text-center md:text-left space-y-6">
                    <h2 class="text-4xl md:text-6xl font-black drop-shadow-lg leading-tight">
                        想像 • 實作 <br>
                        <span class="text-yellow-300">創新未來</span>
                    </h2>
                    <p class="text-xl md:text-2xl font-light opacity-90">
                        七堵國小 STEAM MAKER <br>
                        讓孩子的創意動起來，將點子變成現實！
                    </p>
                    <div class="pt-4">
                        <a href="#simulator" class="inline-block bg-white font-bold py-4 px-10 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition transform duration-200 theme-text-primary">
                            <i data-lucide="play-circle" class="inline-block w-6 h-6 mr-2 align-text-bottom"></i>
                            體驗線上積木牆
                        </a>
                    </div>
                </div>
                <div class="md:w-1/2 relative w-full max-w-lg">
                    <div class="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
                    <div class="absolute top-0 -right-4 w-72 h-72 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>
                    <div class="absolute -bottom-8 left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-4000"></div>
                    
                    <div class="relative rounded-2xl overflow-hidden shadow-2xl border-4 border-white/30 backdrop-blur-sm transform rotate-2 hover:rotate-0 transition duration-500 bg-black/20 group">
                        <video autoplay loop muted playsinline class="w-full h-auto object-cover">
                            <source src="grok-video-9cac6a83-05ca-4699-ac73-2914f627a8ca.mp4" type="video/mp4">
                            您的瀏覽器不支援影片標籤。
                        </video>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- STEAM 理念 -->
    <section id="philosophy" class="py-16 bg-white relative z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-3xl font-bold text-gray-900">STEAM 教育核心</h2>
                <div class="w-20 h-1 mx-auto mt-4 rounded theme-bg-secondary"></div>
                <p class="mt-4 text-gray-600">點擊下方卡片，深入了解各領域內涵</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 text-center">
                <button onclick="openModal('S')" class="p-6 rounded-xl bg-blue-50 hover:bg-blue-100 hover:-translate-y-2 transition duration-300 shadow-sm hover:shadow-md cursor-pointer group">
                    <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl font-bold group-hover:scale-110 transition">S</div>
                    <h3 class="text-xl font-bold mb-2">Science</h3>
                    <p class="text-sm text-gray-600">科學探究</p>
                </button>
                <button onclick="openModal('T')" class="p-6 rounded-xl bg-green-50 hover:bg-green-100 hover:-translate-y-2 transition duration-300 shadow-sm hover:shadow-md cursor-pointer group">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl font-bold group-hover:scale-110 transition">T</div>
                    <h3 class="text-xl font-bold mb-2">Technology</h3>
                    <p class="text-sm text-gray-600">科技運用</p>
                </button>
                <button onclick="openModal('E')" class="p-6 rounded-xl bg-yellow-50 hover:bg-yellow-100 hover:-translate-y-2 transition duration-300 shadow-sm hover:shadow-md cursor-pointer group">
                    <div class="w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl font-bold group-hover:scale-110 transition">E</div>
                    <h3 class="text-xl font-bold mb-2">Engineering</h3>
                    <p class="text-sm text-gray-600">工程設計</p>
                </button>
                <button onclick="openModal('A')" class="p-6 rounded-xl bg-red-50 hover:bg-red-100 hover:-translate-y-2 transition duration-300 shadow-sm hover:shadow-md cursor-pointer group">
                    <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl font-bold group-hover:scale-110 transition">A</div>
                    <h3 class="text-xl font-bold mb-2">Art</h3>
                    <p class="text-sm text-gray-600">藝術美感</p>
                </button>
                <button onclick="openModal('M')" class="p-6 rounded-xl bg-purple-50 hover:bg-purple-100 hover:-translate-y-2 transition duration-300 shadow-sm hover:shadow-md cursor-pointer group">
                    <div class="w-16 h-16 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-4 text-white text-2xl font-bold group-hover:scale-110 transition">M</div>
                    <h3 class="text-xl font-bold mb-2">Math</h3>
                    <p class="text-sm text-gray-600">數學邏輯</p>
                </button>
            </div>
        </div>
    </section>

    <!-- MAKER 花絮 -->
    <section id="maker-gallery" class="py-16 bg-gray-50 relative z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="text-3xl font-bold text-gray-900">MAKER 花絮</h2>
                <div class="w-20 h-1 mx-auto mt-4 rounded" style="background-color: var(--color-accent)"></div>
                <p class="mt-4 text-gray-600">孩子們專注創作的精彩瞬間</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- 圖片 1-6 -->
                <div class="relative group cursor-pointer hover:z-10 transition-all duration-300 transform hover:-rotate-2">
                    <div class="bg-pink-100 p-3 shadow-lg rounded-sm transform rotate-1 border border-gray-200">
                        <div class="tape-effect bg-yellow-100/80"></div>
                        <div class="overflow-hidden aspect-[4/3]">
                            <img src="1.jpg" alt="花絮照片 1" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        </div>
                        <div class="text-center pt-3 font-handwriting text-gray-600 text-sm font-bold">專注時刻</div>
                    </div>
                </div>
                <div class="relative group cursor-pointer hover:z-10 transition-all duration-300 transform hover:rotate-2">
                    <div class="bg-rose-100 p-3 shadow-lg rounded-sm transform -rotate-1 border border-gray-200">
                        <div class="tape-effect bg-blue-100/80"></div>
                        <div class="overflow-hidden aspect-[4/3]">
                            <img src="2.jpg" alt="花絮照片 2" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        </div>
                        <div class="text-center pt-3 font-handwriting text-gray-600 text-sm font-bold">動手實作</div>
                    </div>
                </div>
                <div class="relative group cursor-pointer hover:z-10 transition-all duration-300 transform hover:-rotate-1">
                    <div class="bg-fuchsia-100 p-3 shadow-lg rounded-sm transform rotate-2 border border-gray-200">
                        <div class="tape-effect bg-green-100/80"></div>
                        <div class="overflow-hidden aspect-[4/3]">
                            <img src="3.jpg" alt="花絮照片 3" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        </div>
                        <div class="text-center pt-3 font-handwriting text-gray-600 text-sm font-bold">創意激盪</div>
                    </div>
                </div>
                <div class="relative group cursor-pointer hover:z-10 transition-all duration-300 transform hover:rotate-2">
                    <div class="bg-red-100 p-3 shadow-lg rounded-sm transform -rotate-2 border border-gray-200">
                        <div class="tape-effect bg-pink-100/80"></div>
                        <div class="overflow-hidden aspect-[4/3]">
                            <img src="4.jpg" alt="花絮照片 4" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        </div>
                        <div class="text-center pt-3 font-handwriting text-gray-600 text-sm font-bold">師生互動</div>
                    </div>
                </div>
                <div class="relative group cursor-pointer hover:z-10 transition-all duration-300 transform hover:-rotate-2">
                    <div class="bg-pink-200 p-3 shadow-lg rounded-sm transform rotate-1 border border-gray-200">
                        <div class="tape-effect bg-purple-100/80"></div>
                        <div class="overflow-hidden aspect-[4/3]">
                            <img src="5.jpg" alt="花絮照片 5" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        </div>
                        <div class="text-center pt-3 font-handwriting text-gray-600 text-sm font-bold">同儕合作</div>
                    </div>
                </div>
                <div class="relative group cursor-pointer hover:z-10 transition-all duration-300 transform hover:rotate-1">
                    <div class="bg-rose-200 p-3 shadow-lg rounded-sm transform -rotate-1 border border-gray-200">
                        <div class="tape-effect bg-orange-100/80"></div>
                        <div class="overflow-hidden aspect-[4/3]">
                            <img src="6.jpg" alt="花絮照片 6" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        </div>
                        <div class="text-center pt-3 font-handwriting text-gray-600 text-sm font-bold">成果展示</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 互動積木牆 Simulator -->
    <section id="simulator" class="py-12 bg-white relative z-10">
        <div class="max-w-7xl mx-auto px-4">
            <!-- 每日挑戰橫幅 -->
            <div id="missionBanner" class="bg-gradient-to-r from-yellow-200 to-yellow-100 border-l-4 border-yellow-500 p-4 mb-6 rounded shadow-md flex justify-between items-center hidden transition-all duration-500 transform translate-y-0">
                <div class="flex items-center gap-3">
                    <div class="bg-yellow-500 text-white p-2 rounded-full shadow-md"><i data-lucide="trophy" class="w-6 h-6"></i></div>
                    <div>
                        <h4 class="font-bold text-gray-800 text-lg">今日挑戰：<span id="missionText" class="text-blue-600">載入中...</span></h4>
                        <p class="text-sm text-gray-600">完成任務後，請點擊右側按鈕領取獎勵！</p>
                    </div>
                </div>
                <button onclick="completeMission()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-full font-bold shadow-md hover:shadow-lg transition transform hover:scale-105 flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-5 h-5"></i> 任務完成
                </button>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-end mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900 flex items-center gap-2">
                        <i data-lucide="settings" class="theme-text-primary"></i>
                        線上積木創客牆
                    </h2>
                    <p class="text-gray-600 mt-2">
                        使用左側更多元的零件，打造你的創意機關！<br>
                        <span class="text-sm text-blue-600 font-bold">提示：運轉時點擊齒輪可啟動動力 | <span class="text-red-600">雙擊積木</span>可旋轉</span>
                    </p>
                </div>
                <div class="flex gap-3 mt-4 md:mt-0 items-center">
                    <button onclick="startMission()" class="px-4 py-2 bg-yellow-400 text-white rounded-lg hover:bg-yellow-500 font-bold shadow-md hover:shadow-lg transition flex items-center gap-2 transform hover:-translate-y-1">
                        <i data-lucide="flag" class="w-5 h-5"></i> 每日任務
                    </button>
                    <button onclick="clearBoard()" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-bold transition flex items-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> 清空
                    </button>
                    <!-- 按鈕顏色跟隨副色 (Secondary) -->
                    <button id="toggleRunBtn" onclick="toggleSimulation()" class="px-6 py-2 text-white rounded-lg font-bold shadow-lg transition flex items-center gap-2 theme-bg-secondary">
                        <i data-lucide="play" class="w-5 h-5"></i> <span id="runBtnText">開始運轉</span>
                    </button>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                <!-- 工具箱 -->
                <div class="lg:w-72 bg-white p-4 rounded-xl shadow-lg border border-gray-200 max-h-[800px] overflow-y-auto">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2 flex items-center gap-2">
                        <i data-lucide="box" class="w-4 h-4"></i> 零件箱
                    </h3>
                    <div class="space-y-4">
                        <!-- 齒輪區 -->
                        <div>
                            <p class="text-xs text-gray-400 font-bold mb-2">動力齒輪 (Gears)</p>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="selectTool('gear', 'red', 40, 12)" class="tool-btn hover:bg-gray-50 p-1 rounded border border-transparent hover:border-gray-200 flex flex-col items-center group"><div class="w-8 h-8 rounded-full border-2 border-dashed border-red-500 group-hover:rotate-45 transition"></div><span class="text-[10px] mt-1">紅(12齒)</span></button>
                                <button onclick="selectTool('gear', 'blue', 60, 20)" class="tool-btn hover:bg-gray-50 p-1 rounded border border-transparent hover:border-gray-200 flex flex-col items-center group"><div class="w-10 h-10 rounded-full border-2 border-dashed border-blue-500 group-hover:rotate-45 transition"></div><span class="text-[10px] mt-1">藍(20齒)</span></button>
                                <button onclick="selectTool('gear', 'yellow', 80, 28)" class="tool-btn hover:bg-gray-50 p-1 rounded border border-transparent hover:border-gray-200 flex flex-col items-center group"><div class="w-12 h-12 rounded-full border-2 border-dashed border-yellow-500 group-hover:rotate-45 transition"></div><span class="text-[10px] mt-1">黃(28齒)</span></button>
                            </div>
                        </div>
                        <!-- 結構與裝飾 -->
                        <div>
                            <p class="text-xs text-gray-400 font-bold mb-2">結構積木 (Beams)</p>
                            <div class="space-y-2">
                                <button onclick="selectTool('beam', '#4ade80', 120, 20)" class="w-full tool-btn hover:bg-gray-50 p-2 rounded border border-transparent hover:border-gray-200 flex items-center gap-2"><div class="w-16 h-3 bg-green-400 rounded-full"></div><span class="text-xs">長條 (5孔)</span></button>
                                <button onclick="selectTool('beam', '#a78bfa', 80, 20)" class="w-full tool-btn hover:bg-gray-50 p-2 rounded border border-transparent hover:border-gray-200 flex items-center gap-2"><div class="w-10 h-3 bg-purple-400 rounded-full"></div><span class="text-xs">短條 (3孔)</span></button>
                                <button onclick="selectTool('l-beam', '#fb923c', 80, 20)" class="w-full tool-btn hover:bg-gray-50 p-2 rounded border border-transparent hover:border-gray-200 flex items-center gap-2"><div class="relative w-8 h-8"><div class="absolute top-0 left-0 w-3 h-8 bg-orange-400 rounded-full"></div><div class="absolute bottom-0 left-0 w-8 h-3 bg-orange-400 rounded-full"></div></div><span class="text-xs">L型轉角</span></button>
                                <!-- 修改名稱為 X型連接 -->
                                <button onclick="selectTool('x-beam', '#22d3ee', 80, 20)" class="w-full tool-btn hover:bg-gray-50 p-2 rounded border border-transparent hover:border-gray-200 flex items-center gap-2"><div class="relative w-8 h-8 flex items-center justify-center"><div class="absolute w-3 h-8 bg-cyan-400 rounded-full transform rotate-45"></div><div class="absolute w-8 h-3 bg-cyan-400 rounded-full transform rotate-45"></div></div><span class="text-xs">X型連接</span></button>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-400 font-bold mb-2">特殊零件 (Special)</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="selectTool('fan', '#ec4899', 100, 0)" class="tool-btn hover:bg-gray-50 p-2 rounded border border-transparent hover:border-gray-200 flex flex-col items-center group"><i data-lucide="fan" class="text-pink-500 w-8 h-8 group-hover:rotate-90 transition"></i><span class="text-[10px] mt-1">風扇葉片</span></button>
                                <!-- 新增 大風扇葉片 -->
                                <button onclick="selectTool('fan-large', '#db2777', 160, 0)" class="tool-btn hover:bg-gray-50 p-2 rounded border border-transparent hover:border-gray-200 flex flex-col items-center group"><i data-lucide="fan" class="text-pink-600 w-10 h-10 group-hover:rotate-90 transition"></i><span class="text-[10px] mt-1">大風扇葉片</span></button>
                                <button onclick="selectTool('axle', '#94a3b8', 20, 0)" class="tool-btn hover:bg-gray-50 p-2 rounded border border-transparent hover:border-gray-200 flex flex-col items-center"><div class="w-4 h-4 rounded-full bg-slate-400 border-2 border-slate-600"></div><span class="text-[10px] mt-1">固定軸</span></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 畫布區域 -->
                <div class="flex-1 relative rounded-xl overflow-hidden shadow-2xl border-4 border-gray-700 h-[600px] bg-neutral-800">
                    <canvas id="makerCanvas" class="grid-bg w-full h-full block"></canvas>
                    <div id="activeToolDisplay" class="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-sm font-bold shadow-md hidden pointer-events-none text-blue-800 border border-blue-200">
                        目前手持: <span id="toolName">無</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 作品導引 -->
    <section id="gallery" class="py-16 bg-white relative z-10">
        <div class="max-w-7xl mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-10">小小創客作品導引</h2>
            <p class="text-center text-gray-500 mb-8 -mt-6">點擊下方範例，即可在積木牆上載入作品！</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- 範例一 -->
                <div onclick="loadPreset('arm')" class="rounded-lg overflow-hidden shadow-lg group relative cursor-pointer hover:shadow-2xl transition transform hover:-translate-y-1 bg-white border border-gray-100">
                    <div class="h-48 bg-blue-50 flex items-center justify-center overflow-hidden relative">
                        <i data-lucide="grab" class="w-20 h-20 text-blue-400 opacity-80 group-hover:scale-110 transition duration-500"></i>
                        <div class="absolute bottom-2 right-2 bg-blue-600 text-white text-xs px-2 py-1 rounded">點擊載入</div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg text-gray-800">範例一：連動機械手臂</h3>
                        <p class="text-gray-500 text-sm mt-1">利用連桿機構與齒輪傳動，模擬手臂抓取動作。</p>
                        <div class="mt-3 flex gap-2">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">五年級</span>
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">工程</span>
                        </div>
                    </div>
                </div>
                <!-- 範例二 -->
                <div onclick="loadPreset('ferris')" class="rounded-lg overflow-hidden shadow-lg group relative cursor-pointer hover:shadow-2xl transition transform hover:-translate-y-1 bg-white border border-gray-100">
                    <div class="h-48 bg-yellow-50 flex items-center justify-center overflow-hidden relative">
                        <i data-lucide="loader-2" class="w-20 h-20 text-yellow-400 opacity-80 group-hover:rotate-90 transition duration-700"></i>
                        <div class="absolute bottom-2 right-2 bg-yellow-600 text-white text-xs px-2 py-1 rounded">點擊載入</div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg text-gray-800">範例二：遊樂園摩天輪</h3>
                        <p class="text-gray-500 text-sm mt-1">大型齒輪帶動外圈結構，展現穩定的圓周運動。</p>
                        <div class="mt-3 flex gap-2">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">四年級</span>
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">數學</span>
                        </div>
                    </div>
                </div>
                <!-- 範例三 -->
                <div onclick="loadPreset('car')" class="rounded-lg overflow-hidden shadow-lg group relative cursor-pointer hover:shadow-2xl transition transform hover:-translate-y-1 bg-white border border-gray-100">
                    <div class="h-48 bg-green-50 flex items-center justify-center overflow-hidden relative">
                        <i data-lucide="car" class="w-20 h-20 text-green-400 opacity-80 group-hover:translate-x-4 transition duration-500"></i>
                        <div class="absolute bottom-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded">點擊載入</div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg text-gray-800">範例三：橡皮筋動力車</h3>
                        <p class="text-gray-500 text-sm mt-1">透過多級齒輪變速，將動力傳輸至輪子。</p>
                        <div class="mt-3 flex gap-2">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">六年級</span>
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">科學</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12 border-t border-gray-800 relative z-10">
        <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
            <div class="mb-6 md:mb-0 text-center md:text-left">
                <h3 class="text-2xl font-bold">七堵國小 STEAM MAKER</h3>
                <p class="text-gray-400 mt-2">啟發孩子未來的無限可能</p>
            </div>
            <div class="text-gray-500 text-sm text-center md:text-right">
                <p>&copy; Keelung Municipal Qidu Elementary School.</p>
                <p>Designed for STEAM Education.</p>
            </div>
        </div>
    </footer>

    <!-- STEAM 詳解 Modals -->
    <div id="steamModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 modal">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 md:w-1/2 max-w-2xl overflow-hidden transform transition-all scale-95" id="modalContent">
            <div id="modalHeader" class="p-6 text-white bg-blue-600 flex justify-between items-center">
                <h3 id="modalTitle" class="text-2xl font-bold">標題</h3>
                <button onclick="closeModal()" class="text-white hover:text-gray-200">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>
            <div class="p-8">
                <div id="modalBody" class="text-gray-700 text-lg leading-relaxed space-y-4"></div>
                <div class="mt-8 flex justify-end">
                    <button onclick="closeModal()" class="px-6 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-800 font-bold transition">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        lucide.createIcons();

        /* --- 主題選單邏輯 --- */
        function toggleThemeMenu(event) {
            event.stopPropagation(); 
            const menu = document.getElementById('themeMenu');
            menu.classList.toggle('hidden');
        }

        document.addEventListener('click', function(event) {
            const menu = document.getElementById('themeMenu');
            const dropdown = document.getElementById('themeDropdown');
            if (!dropdown.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        function setTheme(theme) { 
            document.body.setAttribute('data-theme', theme); 
            document.getElementById('themeMenu').classList.add('hidden'); 
        }

        /* --- 視差捲動 --- */
        document.addEventListener('scroll', () => {
            const scrollY = window.scrollY;
            document.querySelectorAll('.parallax-item').forEach(item => {
                const speed = item.getAttribute('data-speed');
                item.style.transform = `translateY(${scrollY * speed}px)`;
            });
        });

        /* --- 吉祥物互動 (修改：onmouseenter 觸發) --- */
        const quotes = [
            "大齒輪帶動小齒輪會變快喔！",
            "STEAM 是科學、科技、工程、藝術和數學的縮寫！",
            "試試看用 L 型積木做一個夾子吧！",
            "加油！你是最棒的小小創客！",
            "失敗沒關係，那是成功的養分！",
            "齒輪的牙齒叫做「齒」，要咬合才能轉動喔！",
            "多用幾種顏色，讓作品更漂亮！"
        ];
        let idleTimer;
        const IDLE_LIMIT = 10000; 

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            const mascot = document.getElementById('mascot');
            mascot.classList.remove('mascot-idle'); 
            idleTimer = setTimeout(() => {
                mascot.classList.add('mascot-idle'); 
            }, IDLE_LIMIT);
        }

        function mascotInteract() {
            const bubble = document.getElementById('mascotSpeech');
            const container = document.getElementById('mascot');
            
            if (container.classList.contains('speaking')) return;

            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            bubble.innerHTML = randomQuote;
            container.classList.add('speaking');
            setTimeout(() => { container.classList.remove('speaking'); }, 4000);
            resetIdleTimer(); 
        }

        ['mousemove', 'click', 'keydown', 'scroll'].forEach(evt => 
            document.addEventListener(evt, resetIdleTimer)
        );
        resetIdleTimer();

        /* --- 每日任務 --- */
        const missions = [
            "使用至少 3 個紅色齒輪製作一個連動裝置",
            "製作一個擁有 4 個輪子的動力車底盤",
            "利用 L 型積木搭建一個穩固的三角形結構",
            "讓藍色齒輪與黃色齒輪成功嚙合轉動",
            "製作一個能夠快速旋轉的風扇裝置"
        ];

        function startMission() {
            const banner = document.getElementById('missionBanner');
            const text = document.getElementById('missionText');
            const randomMission = missions[Math.floor(Math.random() * missions.length)];
            text.innerText = randomMission;
            banner.classList.remove('hidden');
            banner.scrollIntoView({behavior: 'smooth', block: 'center'});
        }

        function completeMission() {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            setTimeout(() => { document.getElementById('missionBanner').classList.add('hidden'); }, 3000);
        }

        /* --- 音樂控制 (使用 My ProjectD.m4a) --- */
        const bgMusic = document.getElementById('bgMusic');
        let isMusicPlaying = false;
        function updateMusicUI(playing) {
             const icon = document.getElementById('musicIcon');
             const btn = icon.parentElement;
             if(playing) {
                icon.innerHTML = '<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle><path d="M2 10v3"/><path d="M22 10v3"/>';
                btn.classList.add('bg-pink-100');
             } else {
                icon.innerHTML = '<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle>';
                btn.classList.remove('bg-pink-100');
             }
             lucide.createIcons();
        }
        function toggleMusic() {
            if (isMusicPlaying) { bgMusic.pause(); isMusicPlaying = false; } 
            else { bgMusic.volume = 0.3; bgMusic.play().catch(e=>{}); isMusicPlaying = true; }
            updateMusicUI(isMusicPlaying);
        }
        document.addEventListener('DOMContentLoaded', () => {
             bgMusic.volume = 0.3;
             if (!bgMusic.paused) { isMusicPlaying = true; updateMusicUI(true); } 
             else { 
                 bgMusic.play().then(() => { isMusicPlaying = true; updateMusicUI(true); })
                 .catch(() => { isMusicPlaying = false; updateMusicUI(false); document.body.addEventListener('click', () => { if(!isMusicPlaying) { bgMusic.play(); isMusicPlaying = true; updateMusicUI(true); } }, { once: true }); });
             }
        });

        /* --- STEAM Modal --- */
        const steamContent = {
            'S': { title: 'Science (科學)', color: 'bg-blue-600', body: '<p>在創客牆中，科學體現在<strong>「觀察與驗證」</strong>。孩子們透過觀察齒輪的大小如何影響轉速（齒輪比），理解機械傳動的物理原理。</p>' },
            'T': { title: 'Technology (科技)', color: 'bg-green-600', body: '<p>科技不只是電腦，更包含了<strong>「工具的使用」</strong>。在我們的課程中，這面創客牆本身就是一種低科技（Low-Tech）的模擬工具。</p>' },
            'E': { title: 'Engineering (工程)', color: 'bg-yellow-500', body: '<p>工程是關於<strong>「結構與建造」</strong>。在搭建過程中，孩子必須考慮重心、支撐點與結構強度，這就是小小結構工程師的日常挑戰！</p>' },
            'A': { title: 'Art (藝術)', color: 'bg-red-500', body: '<p>STEAM 中的 A 代表藝術，強調<strong>「美感與設計」</strong>。機械裝置不僅要能動，還要有美感。</p>' },
            'M': { title: 'Math (數學)', color: 'bg-purple-600', body: '<p>數學是機械運作的基石。<strong>「比例與幾何」</strong>無處不在。</p>' }
        };
        function openModal(type) {
            const data = steamContent[type];
            document.getElementById('modalTitle').innerText = data.title;
            document.getElementById('modalBody').innerHTML = data.body;
            document.getElementById('modalHeader').className = `p-6 text-white flex justify-between items-center ${data.color}`;
            document.getElementById('steamModal').classList.add('active');
            document.getElementById('modalContent').classList.remove('scale-95');
            document.getElementById('modalContent').classList.add('scale-100');
        }
        function closeModal() {
            document.getElementById('steamModal').classList.remove('active');
            document.getElementById('modalContent').classList.add('scale-95');
            document.getElementById('modalContent').classList.remove('scale-100');
        }

        /* --- Canvas Logic (修正) --- */
        const canvas = document.getElementById('makerCanvas');
        const ctx = canvas.getContext('2d');
        const GRID_SIZE = 40; 
        function resizeCanvas() {
            const parent = canvas.parentElement;
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            draw();
        }
        window.addEventListener('resize', resizeCanvas);
        let items = [];
        let selectedTool = null;
        let isDragging = false;
        let dragItem = null;
        let isRunning = false;
        let animationFrameId;
        let baseRotation = 0; 

        window.loadPreset = function(type) {
            stopSimulation(); items = []; 
            document.getElementById('simulator').scrollIntoView({behavior: 'smooth'});
            // Reset items with updated types/structure
            if (type === 'arm') { 
                items.push(
                    {type: 'beam', color: '#4ade80', size: 120, x: 200, y: 300}, 
                    {type: 'beam', color: '#a78bfa', size: 80, x: 200, y: 260}, 
                    {type: 'gear', color: 'blue', size: 60, teeth: 20, x: 200, y: 300, isDriver: true}, 
                    {type: 'gear', color: 'red', size: 40, teeth: 12, x: 250, y: 300}, 
                    {type: 'l-beam', color: '#fb923c', size: 80, x: 250, y: 260}, 
                    {type: 'axle', color: '#94a3b8', size: 20, x: 200, y: 300}
                ); 
            } else if (type === 'ferris') { 
                const cx = canvas.width / 2; const cy = canvas.height / 2; 
                items.push(
                    {type: 'gear', color: 'yellow', size: 80, teeth: 28, x: cx, y: cy, isDriver: true}, 
                    {type: 'beam', color: '#4ade80', size: 120, x: cx, y: cy}, 
                    {type: 'beam', color: '#4ade80', size: 120, x: cx, y: cy, rotation: Math.PI/2}, 
                    {type: 'gear', color: 'red', size: 40, teeth: 12, x: cx-60, y: cy}, 
                    {type: 'gear', color: 'red', size: 40, teeth: 12, x: cx+60, y: cy}, 
                    {type: 'gear', color: 'red', size: 40, teeth: 12, x: cx, y: cy-60}, 
                    {type: 'gear', color: 'red', size: 40, teeth: 12, x: cx, y: cy+60}
                ); 
            } else if (type === 'car') { 
                items.push(
                    {type: 'beam', color: '#4ade80', size: 120, x: 160, y: 300}, 
                    {type: 'beam', color: '#4ade80', size: 120, x: 280, y: 300}, 
                    {type: 'gear', color: 'yellow', size: 80, teeth: 28, x: 120, y: 300}, 
                    {type: 'gear', color: 'yellow', size: 80, teeth: 28, x: 320, y: 300}, 
                    {type: 'gear', color: 'blue', size: 60, teeth: 20, x: 220, y: 260, isDriver: true}, 
                    {type: 'fan', color: '#ec4899', size: 100, x: 220, y: 260}
                ); 
            }
            draw(); 
        };

        window.selectTool = function(type, color, size, teeth) {
            selectedTool = { type, color, size, teeth };
            let name = type;
            if (type === 'gear') name = `齒輪 (${teeth}齒)`;
            else if (type === 'beam') name = '長條積木';
            else if (type === 'fan-large') name = '大風扇葉片';
            else if (type === 'x-beam') name = 'X型連接';
            document.getElementById('toolName').innerText = name;
            document.getElementById('activeToolDisplay').classList.remove('hidden');
        };
        
        window.clearBoard = function() { items = []; stopSimulation(); draw(); };
        
        window.toggleSimulation = function() {
            // 如果正在運轉，則停止
            if (isRunning) {
                stopSimulation();
                const btn = document.getElementById('toggleRunBtn');
                btn.innerHTML = `<i data-lucide="play" class="w-5 h-5"></i> 開始運轉`;
                const secondaryColor = getComputedStyle(document.body).getPropertyValue('--color-secondary').trim();
                btn.style.backgroundColor = secondaryColor;
            } else {
                // 開始運轉
                isRunning = true;
                const btn = document.getElementById('toggleRunBtn');
                btn.innerHTML = `<i data-lucide="pause" class="w-5 h-5"></i> 停止運轉`;
                btn.style.backgroundColor = "#f97316";
                animate();
            }
            lucide.createIcons();
        };

        function stopSimulation() { 
            isRunning = false; 
            cancelAnimationFrame(animationFrameId); 
            // 重置所有齒輪動力
            items.forEach(i => { if(i.type === 'gear') i.powered = false; });
            draw();
        }

        // 動力計算函數 (Power Propagation)
        function updateGearPower() {
            // 重置所有齒輪
            items.forEach(i => { if(i.type === 'gear') i.powered = false; });
            
            // 找到所有驅動齒輪
            let queue = items.filter(i => i.type === 'gear' && i.isDriver);
            queue.forEach(i => i.powered = true);
            
            let processed = new Set(queue.map(i => i.id));
            
            while(queue.length > 0) {
                let current = queue.shift();
                
                // 尋找接觸的齒輪
                items.forEach(other => {
                    if(other.type === 'gear' && !processed.has(other.id)) {
                        let dist = Math.hypot(current.x - other.x, current.y - other.y);
                        let touchDist = (current.size + other.size) / 2;
                        // 允許一點誤差 (5px)
                        if (dist < touchDist + 5) {
                            other.powered = true;
                            processed.add(other.id);
                            queue.push(other);
                        }
                    }
                });
            }
        }

        function draw() { 
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            items.filter(i => i.type.includes('beam')).forEach(drawItem);
            items.filter(i => i.type === 'gear').forEach(drawItem);
            items.filter(i => i.type.includes('fan') || i.type === 'axle').forEach(drawItem);
        }

        function drawItem(item) {
            ctx.save(); 
            ctx.translate(item.x, item.y);
            
            let currentRotation = item.rotation || 0;
            if(item.rotation90) currentRotation += Math.PI/2;

            if (isRunning) {
                // 風扇自動旋轉
                if (item.type.includes('fan')) {
                    currentRotation += baseRotation;
                }
                // 齒輪需有動力才旋轉
                else if (item.type === 'gear' && item.powered) {
                    const direction = (Math.floor(item.x/10) + Math.floor(item.y/10)) % 2 === 0 ? 1 : -1;
                    currentRotation += baseRotation * direction;
                }
            }
            
            ctx.rotate(currentRotation);
            
            if (item.type === 'gear') {
                ctx.fillStyle = item.color; 
                const teeth = item.teeth || 12;
                const outerRadius = item.size / 2;
                const innerRadius = outerRadius - 6; 
                const holeRadius = 6;

                // 畫出鋸齒狀齒輪
                ctx.beginPath();
                for (let i = 0; i < teeth * 2; i++) {
                    const angle = (Math.PI * 2 * i) / (teeth * 2);
                    const r = (i % 2 === 0) ? outerRadius : innerRadius;
                    ctx.lineTo(Math.cos(angle) * r, Math.sin(angle) * r);
                }
                ctx.closePath();
                ctx.fill();
                ctx.strokeStyle = "rgba(0,0,0,0.2)"; 
                ctx.lineWidth = 1; 
                ctx.stroke();

                // 中心孔
                ctx.beginPath(); 
                ctx.arc(0,0, holeRadius, 0, Math.PI*2); 
                ctx.fillStyle = '#f3f4f6'; 
                ctx.fill(); 
                ctx.stroke();
                
                // 如果是驅動齒輪，畫個標記
                if (item.isDriver) {
                    ctx.beginPath();
                    ctx.arc(0, 0, 3, 0, Math.PI*2);
                    ctx.fillStyle = '#ef4444'; // 紅點
                    ctx.fill();
                }

            } else if (item.type === 'fan' || item.type === 'fan-large') {
                ctx.fillStyle = item.color; const radius = item.size/2;
                for(let i=0; i<3; i++) { ctx.save(); ctx.rotate(i*(Math.PI*2/3)); ctx.beginPath(); ctx.ellipse(0, -radius/2, 10, radius/2, 0, 0, Math.PI*2); ctx.fill(); ctx.restore(); }
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.fill();
            } else if (item.type === 'axle') {
                ctx.fillStyle = '#94a3b8'; ctx.beginPath(); ctx.arc(0,0,8,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#475569'; ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-4,0); ctx.lineTo(4,0); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,-4); ctx.lineTo(0,4); ctx.stroke();
            } else if (item.type.includes('beam')) { 
                ctx.fillStyle = item.color;
                if(item.type === 'l-beam') { ctx.beginPath(); ctx.roundRect(-10, -40, 20, 80, 10); ctx.fill(); ctx.beginPath(); ctx.roundRect(-10, 20, 60, 20, 10); ctx.fill(); }
                else if(item.type === 't-beam') { ctx.beginPath(); ctx.roundRect(-10, -40, 20, 80, 10); ctx.fill(); ctx.beginPath(); ctx.roundRect(-40, -10, 80, 20, 10); ctx.fill(); }
                else if(item.type === 'x-beam') { 
                    // X型連接：畫一個十字
                    ctx.beginPath(); ctx.roundRect(-10, -40, 20, 80, 10); ctx.fill(); 
                    ctx.beginPath(); ctx.roundRect(-40, -10, 80, 20, 10); ctx.fill(); 
                    // 中心孔
                    ctx.fillStyle = '#2a2a2a'; ctx.beginPath(); ctx.arc(0,0,4,0,Math.PI*2); ctx.fill();
                }
                else { ctx.beginPath(); ctx.roundRect(-item.size/2, -10, item.size, 20, 10); ctx.fill(); }
                
                // 畫孔洞 (針對一般長條和L型，X型已處理)
                ctx.fillStyle = '#2a2a2a'; 
                if(item.type==='beam') { const holes=Math.floor(item.size/20); const startX=-((holes-1)*20)/2; for(let k=0; k<holes; k++) { ctx.beginPath(); ctx.arc(startX+k*20,0,4,0,Math.PI*2); ctx.fill(); } }
                else if(item.type==='l-beam') { [-30,-10,10,30].forEach(y=> {ctx.beginPath();ctx.arc(0,y,4,0,Math.PI*2);ctx.fill()}); [20,40].forEach(x=>{ctx.beginPath();ctx.arc(x,30,4,0,Math.PI*2);ctx.fill()}); } 
            }
            ctx.restore();
        }
        
        function animate() {
            if (!isRunning) return;
            baseRotation += 0.05; 
            // 每次更新都重新計算動力傳遞，以防位置變動(雖目前運轉中不可移動，但為保險)
            updateGearPower();
            draw();
            animationFrameId = requestAnimationFrame(animate);
        }

        function getMousePos(evt) { const rect = canvas.getBoundingClientRect(); return { x: evt.clientX - rect.left, y: evt.clientY - rect.top }; }
        function snapToGrid(val) { return Math.round(val / (GRID_SIZE/2)) * (GRID_SIZE/2); }
        
        canvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(e);
            
            // 運轉模式下的點擊互動 (設定驅動齒輪)
            if (isRunning) {
                for (let i = items.length - 1; i >= 0; i--) {
                    const item = items[i]; 
                    const dx = pos.x - item.x; const dy = pos.y - item.y;
                    if (Math.sqrt(dx*dx + dy*dy) < 30) {
                        if (item.type === 'gear') {
                            item.isDriver = !item.isDriver; // 切換驅動狀態
                            // 音效回饋
                            // const clickSound = new Audio('path/to/click.mp3'); // 選填
                            // clickSound.play();
                        }
                        return; // 運轉中只處理點擊，不處理拖曳
                    }
                }
                return;
            }

            // 編輯模式
            let clicked = false;
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i]; const dx = pos.x - item.x; const dy = pos.y - item.y;
                if (Math.sqrt(dx*dx + dy*dy) < 30) {
                    if (e.button === 2) { 
                        items.splice(i, 1); 
                        draw(); 
                        return; 
                    }
                    else { 
                        isDragging = true; 
                        dragItem = item; 
                        clicked = true;
                        return; 
                    }
                }
            }
            if (!clicked && selectedTool && e.button === 0) { 
                items.push({ ...selectedTool, x: snapToGrid(pos.x), y: snapToGrid(pos.y), id: Date.now(), rotation: 0 }); 
                draw(); 
            }
        });

        // 雙擊旋轉功能
        canvas.addEventListener('dblclick', (e) => {
            if (isRunning) return; // 運轉中不可旋轉
            const pos = getMousePos(e);
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i]; 
                const dx = pos.x - item.x; 
                const dy = pos.y - item.y;
                if (Math.sqrt(dx*dx + dy*dy) < 30) {
                    item.rotation = (item.rotation || 0) + Math.PI/2;
                    draw();
                    return;
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => { if (isDragging && dragItem) { const pos = getMousePos(e); dragItem.x = snapToGrid(pos.x); dragItem.y = snapToGrid(pos.y); draw(); } });
        canvas.addEventListener('mouseup', () => { isDragging = false; dragItem = null; });
        canvas.addEventListener('contextmenu', event => event.preventDefault());
        setTimeout(resizeCanvas, 100); 
    </script>
</body>
</html>